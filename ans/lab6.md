> 思考题 1：请自行查阅资料，并阅读`userland/servers/sd`中的代码，回答以下问题:
> *   circle中还提供了SDHost的代码。SD卡，EMMC和SDHost三者之间的关系是怎么样的？
> *   请**详细**描述Chcore是如何与SD卡进行交互的？即Chcore发出的指令是如何输送到SD卡上，又是如何得到SD卡的响应的。(提示: IO设备常使用MMIO的方式映射到内存空间当中)
> *   请简要介绍一下SD卡驱动的初始化流程。
> *   在驱动代码的初始化当中，设置时钟频率的意义是什么？为什么需要调用`TimeoutWait`进行等待?

1.  SD卡、EMMC和SDHost之间的关系如下：
    *   SD卡（Secure Digital Card）是一种存储设备，用于存储数据，类似于传统的闪存卡。
    *   EMMC（Embedded MultiMedia Card）是一种集成了闪存存储器和控制器的存储设备，它在物理接口和协议层面与SD卡兼容，但通常以嵌入式应用为主。
    *   SDHost是一个驱动程序，用于提供对SD卡和EMMC的控制和访问接口，以便在操作系统中进行SD卡和EMMC的读写操作。

2.  ChCore与SD卡的交互是通过IO设备的内存映射IO（Memory-Mapped I/O，MMIO）方式实现的。具体流程如下：
    *   ChCore将SDHost的寄存器区域映射到内存空间中，使得可以通过内存读写访问SDHost的寄存器。
    *   ChCore通过写入适当的命令和参数到SDHost的寄存器，将指令发送给SD卡或EMMC。
    *   SDHost将指令转发给SD卡或EMMC，并等待其响应。
    *   SDHost接收SD卡或EMMC的响应，并将响应信息写入到寄存器中。
    *   ChCore通过读取相应的寄存器，获取SD卡或EMMC的响应信息。

3.  SD卡驱动的初始化流程主要包括以下步骤：
    *   初始化SDHost驱动：通过适当的方式初始化SDHost驱动，使得SDHost与SD卡或EMMC建立连接。
    *   设置时钟频率：根据SD卡或EMMC的规格和要求，配置SDHost的时钟频率，确保与SD卡或EMMC的通信时钟一致。
    *   发送初始化指令：发送初始化指令给SD卡或EMMC，以使其进入合适的工作状态，并配置其他相关参数。
    *   等待初始化完成：等待SD卡或EMMC完成初始化过程，并检查初始化状态，确保SD卡或EMMC可以正常工作。

4.  设置时钟频率的意义是确保SDHost与SD卡或EMMC之间的数据传输在正确的时钟频率下进行，以便实现稳定的数据传输和通信。适当的时钟频率可以保证数据的可靠性和正确性。 

    调用`TimeoutWait`进行等待的目的是确保在规定的超时时间内等待操作的完成，避免无限等待和阻塞。在SD卡的操作中，特定的命令和操作可能需要一定的时间才能完成，例如读取或写入大量数据、执行复杂的操作等。`TimeoutWait`函数提供了一种超时机制，确保在合理的时间范围内等待操作的完成，以避免程序陷入无限等待状态，同时允许在超时情况下采取适当的错误处理措施。


> 思考题2：查阅资料了解 SD 卡是如何进行分区，又是如何识别分区对应的文件系统的？尝试设计方案为 ChCore 提供多分区的 SD 卡驱动支持，设计其解析与挂载流程。本题的设计部分请在实验报告中详细描述，如果有代码实现，可以编写对应的测试程序放入仓库中提交。

SD卡的分区和文件系统的识别是通过主引导记录（MBR）或GUID分区表（GPT）进行的。

1.  分区过程：

    *   MBR：SD卡使用MBR分区方案时，MBR的第一个扇区（扇区0）包含了分区表。MBR分区表中有4个主分区条目，每个条目记录了一个分区的起始扇区、扇区数和分区类型等信息。MBR分区方案仅支持最多4个主分区。
    *   GPT：SD卡使用GPT分区方案时，GPT分区表存储在SD卡的某个扇区（通常是LBA 1），分区表中包含了分区的详细信息。GPT分区方案支持更多的分区，一般为128个。
2.  文件系统识别过程：

    *   MBR：在MBR分区表中，每个分区条目都有一个分区类型字段。通过读取分区类型字段，可以判断分区对应的文件系统类型。常见的MBR分区类型包括FAT32、NTFS、EXT4等。
    *   GPT：GPT分区表中的每个分区条目都有一个分区类型GUID（GUID Partition Type）。通过比对分区类型GUID与已知的文件系统类型的GUID对应关系，可以识别分区对应的文件系统类型。


针对ChCore提供多分区的SD卡驱动支持，可以设计如下解析与挂载流程：

1. SD卡初始化： 初始化SD卡驱动，确保SD卡硬件正确连接，并准备好与其通信的接口。

2. 分区解析：

    *   读取 SD 卡的主引导记录（MBR）或分区表（GPT/MBR）。
    *   解析主引导记录或分区表，获取分区信息，如起始扇区、大小和文件系统类型。
    *   识别每个分区的类型（如FAT32、EXT4等）。
3. 分区挂载：

    *   创建一个数据结构来表示挂载的分区，包括文件系统类型、设备路径、起始扇区等信息。
    *   初始化文件系统驱动程序，根据文件系统类型选择相应的驱动。
    *   在内核中为每个分区创建相应的文件系统实例，并将其挂载到虚拟文件系统层次结构中的适当位置。
4. 分区访问：

    *   实现文件系统驱动程序，提供文件系统操作接口，如文件读取、写入、创建、删除等。
    *   根据文件路径解析出对应的文件节点，并进行相应的操作。
    *   处理文件系统缓存，包括读取和写入缓存。
    *   管理文件的打开和关闭，维护打开文件表。
5.  错误处理： 在每个步骤中，需要进行错误处理和异常情况的处理。例如，如果分区表解析失败或文件系统识别失败，需要进行适当的错误处理并继续进行后续的操作。